# Đề cương chi tiết Luận văn (v2) - Hướng dẫn xây dựng ứng dụng

## **Chương 3: Cài đặt thực nghiệm hệ thống Chat P2P với trao đổi khóa lai Kyber-X25519**

### **3.1. Môi trường và Công cụ phát triển**
- **Nền tảng Backend:** Node.js (v18.x trở lên), Express.js.
- **Nền tảng Frontend:** HTML5, CSS3, JavaScript (ES6+).
- **Giao tiếp thời gian thực:** Thư viện Socket.IO.
- **Cơ sở dữ liệu:** SQLite 3 để lưu trữ thông tin người dùng.
- **Thư viện mã hóa:**
    - `pqc-kyber`: Cung cấp thuật toán Kyber cho Post-Quantum Cryptography.
    - Web Crypto API (`SubtleCrypto`): API trình duyệt tích hợp sẵn để thực hiện các thuật toán mã hóa kinh điển (X25519, AES-GCM).
- **Đóng gói ứng dụng Desktop:** Electron.js, Electron Builder.
- **Môi trường phát triển:** Visual Studio Code, Node Package Manager (NPM).

---

### **3.2. Các bước xây dựng và cài đặt ứng dụng**

Phần này trình bày quy trình chi tiết, từng bước để xây dựng ứng dụng, từ việc thiết lập môi trường đến khi hoàn thiện các chức năng cốt lõi.

#### **Bước 1: Thiết lập cấu trúc dự án và môi trường**
1.  **Khởi tạo dự án:**
    - Tạo thư mục gốc cho dự án (ví dụ: `p2p-chat`).
    - Chạy lệnh `npm init -y` để tạo file `package.json`.
2.  **Cài đặt các gói phụ thuộc (Dependencies):**
    - **Server:** `npm install express socket.io sqlite3 bcrypt jsonwebtoken`
    - **Mã hóa:** `npm install pqc-kyber`
    - **Desktop App:** `npm install --save-dev electron electron-builder`
3.  **Tạo cấu trúc thư mục:**
    ```
    /p2p-chat
    |-- /public         # Chứa code frontend (HTML, CSS, JS)
    |   |-- index.html
    |   |-- style.css
    |   |-- app.js      # Logic chính của client
    |-- /lib            # Chứa các hàm tiện ích, vd: mã hóa
    |-- main.js         # File khởi tạo của Electron
    |-- server.js       # File backend server
    |-- database.js     # File cấu hình và khởi tạo database
    |-- package.json
    ```

#### **Bước 2: Xây dựng Backend - Server Xác thực và Signaling**
Mục tiêu của bước này là tạo ra một server có hai vai trò: quản lý người dùng và làm trung gian cho việc kết nối P2P.

1.  **Mô đun Database (`database.js`):**
    - Viết hàm kết nối tới file `database.db`.
    - Viết hàm khởi tạo bảng `users` với các cột: `id`, `username`, `password`.
2.  **Mô đun Server (`server.js`):**
    - Khởi tạo một Express server.
    - Cấu hình để phục vụ các file tĩnh từ thư mục `/public`.
3.  **Xây dựng API xác thực:**
    - **API Đăng ký (`POST /api/auth/register`):**
        - Nhận `username` và `password` từ request body.
        - Sử dụng `bcrypt.hashSync()` để băm mật khẩu.
        - Lưu `username` và mật khẩu đã băm vào bảng `users`.
    - **API Đăng nhập (`POST /api/auth/login`):**
        - Nhận `username` và `password`.
        - Truy vấn người dùng từ database.
        - So sánh mật khẩu bằng `bcrypt.compareSync()`.
        - Nếu thành công, tạo và trả về một JSON Web Token (JWT).
4.  **Tích hợp Signaling Server (Socket.IO):**
    - Gắn Socket.IO vào HTTP server đã tạo.
    - Lập trình logic xử lý các sự kiện socket:
        - `connection`: Khi một client kết nối.
        - `register_user (username)`: Lưu lại ánh xạ giữa `socket.id` và `username` để biết ai đang online.
        - `key_exchange (data)`: Nhận gói tin trao đổi khóa từ một client và chuyển tiếp nó đến client đích.
        - `disconnect`: Xóa thông tin người dùng khi họ ngắt kết nối.

#### **Bước 3: Xây dựng Frontend - Giao diện và Logic Client**
Mục tiêu là tạo ra giao diện người dùng và viết mã JavaScript để tương tác với backend.

1.  **Thiết kế giao diện (`index.html`, `style.css`):**
    - Tạo form đăng nhập/đăng ký.
    - Tạo giao diện chat chính, bao gồm: sidebar (tìm kiếm, danh sách liên hệ) và khung chat (hiển thị tin nhắn, ô nhập liệu).
2.  **Lập trình logic Client (`app.js`):**
    - Viết các hàm để gửi yêu cầu `fetch` đến API đăng ký/đăng nhập.
    - Sau khi đăng nhập thành công, lưu JWT vào `localStorage`.
    - Khởi tạo kết nối Socket.IO đến server.
    - Gửi sự kiện `register_user` để định danh với server.
    - Viết các hàm để xử lý sự kiện từ người dùng (gửi tin nhắn, click vào liên hệ).

#### **Bước 4: Cài đặt Lõi Mã hóa và Trao đổi khóa**
Đây là phần trọng tâm của đề tài, được cài đặt hoàn toàn ở phía client (`app.js`).

1.  **Bắt đầu quá trình trao đổi khóa (Client A - Initiator):**
    - Khi người dùng A chọn chat với B, Client A thực hiện:
        - Tạo một cặp khóa Kyber (`pqc.kem.generateKeyPair`).
        - Tạo một cặp khóa X25519 (`window.crypto.subtle.generateKey`).
        - Gửi một sự kiện `key_exchange` qua Socket.IO đến B, chứa: `type: 'offer'`, khóa công khai Kyber, và khóa công khai X25519.
2.  **Phản hồi quá trình trao đổi khóa (Client B - Responder):**
    - Client B lắng nghe sự kiện `key_exchange`. Khi nhận được `offer`:
        - Tạo cặp khóa X25519 của riêng mình.
        - Sử dụng khóa riêng X25519 của mình và khóa công khai X25519 của A để tính ra khóa chung `sharedSecret1` (qua ECDH).
        - Sử dụng khóa công khai Kyber của A để đóng gói, tạo ra bản mã `ciphertext` và khóa chung `sharedSecret2`.
        - Gửi lại sự kiện `key_exchange` cho A, chứa: `type: 'answer'`, khóa công khai X25519 của B, và bản mã `ciphertext` của Kyber.
3.  **Hoàn tất và tạo khóa phiên (Cả hai Client):**
    - **Client A:** Khi nhận được `answer`, A dùng khóa riêng X25519 của mình và khóa công khai của B để tạo ra `sharedSecret1`. Sau đó, dùng khóa riêng Kyber để giải mã `ciphertext` và thu được `sharedSecret2`.
    - **Tạo khóa phiên:** Cả hai client kết hợp `sharedSecret1` và `sharedSecret2` (ví dụ: băm chúng lại với nhau bằng SHA-256) để tạo ra một khóa phiên AES-256 duy nhất.
4.  **Mã hóa và giải mã tin nhắn:**
    - Viết hàm `encryptMessage(text, sessionKey)` sử dụng `window.crypto.subtle.encrypt` với thuật toán `AES-GCM`.
    - Viết hàm `decryptMessage(ciphertext, sessionKey)` sử dụng `window.crypto.subtle.decrypt`.
    - Tất cả tin nhắn gửi đi sau khi trao đổi khóa đều phải được mã hóa bằng hàm này.

#### **Bước 5: Đóng gói thành ứng dụng Desktop**
1.  **Cấu hình Electron (`main.js`):**
    - Viết mã để tạo một cửa sổ trình duyệt (`BrowserWindow`).
    - Load file `index.html` vào cửa sổ.
    - Thêm logic để tự động khởi chạy `server.js` khi ứng dụng Electron bắt đầu.
2.  **Cấu hình Build (`package.json`):**
    - Thêm trường `build` để cấu hình Electron Builder.
    - Chỉ định các file cần đóng gói và các nền tảng đích (Linux AppImage, Windows exe).
3.  **Chạy lệnh Build:**
    - Chạy `npm run build` để đóng gói ứng dụng. File thực thi sẽ được tạo trong thư mục `/dist`.
